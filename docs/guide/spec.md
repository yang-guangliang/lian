# Lian 程序分析框架权威规范

**(Lian Program Analysis Specification)**

**版本：1.3.4**

---

## 0. 规范地位声明（Single Source of Truth）

本规范（Spec）是 Lian 程序分析框架的唯一权威定义。
所有论文写作、技术文档、源代码实现、教学材料与实验解释，必须严格以此为准。
当本 Spec 与既有教材、文献或外部知识库存在不一致时，**以本 Spec 为最终解释依据**。

---

## 1. 程序的基本抽象（Fundamental Abstractions）

### 1.1 符号（Symbol）

符号是程序源代码中所有标识符的**静态实体**。

* **范畴**：变量名、函数名、类名、参数名、临时标识符（Temp）。
* **本质**：语法层面的命名引用，本身不携带运行期取值信息。

### 1.2 抽象值（Abstract Value）

抽象值是对运行期取值空间的**结构化建模**。
一个完整的 Abstract Value 包含：

1. **内存标识（ID）**：抽象域中的唯一识别符。不强制等同于 Allocation Site。
2. **类型属性（Type Attribute）**：元数据属性，**不作为分析的组织轴心**。
3. **嵌套抽象值（Nested Values）**：建模 `obj.field` 或 `arr[i]` 引入的内部结构，支持递归嵌套。

### 1.3 状态（State）

状态被严格定义为：**从符号到抽象值的映射通道（Mapping Channel）**。

#### 形式化定义

#### 语义定位（核心校准）

* **通道本性**：State **不是**一个独立的存储层，也不是控制流快照，而是 Symbol 访问其 Abstract Value 空间的**逻辑通道**。
* **一等分析实体**：在 SFG 中，STATE 以独立节点形式存在。它将“映射关系”具象化，使得“映射”本身可以被复制、包含和追踪。

---

## 2. 分析流水线（Authoritative Pipeline）

1. **GIR 转换**：源语言  GIR，保证语义完整性。
2. **指针级分析**：推导符号指向关系，确立 **Symbol → State → AbstractValue** 的映射链路。
3. **语言差异性兼容**：通过规则/插件处理特定语言语义（如原型链、self 绑定）。
4. **SFG 构造与安全分析**：在映射通道基础上构建状态流图，执行污点跟踪。

---

## 3. 状态流图（State Flow Graph, SFG）

### 3.1 节点定义（SFG_NODE_KIND）

* `SYMBOL`：静态命名节点。
* `STATE`：**映射通道节点**（Symbol 到其 Abstract Value 集合的关联枢纽）。
* `STMT`：程序语句节点。
* `REGULAR`：通用辅助节点。

### 3.2 边定义与语义（SFG_EDGE_KIND）

| 边类型 | 语义描述 | 核心约束 |
| --- | --- | --- |
| **SYMBOL_IS_DEFINED** | 语句定义符号 |  |
| **SYMBOL_IS_USED** | 语句使用符号 |  |
| **SYMBOL_FLOW** | 符号间直接数据流 | 静态层面的值传递 |
| **SYMBOL_STATE** | **符号挂接映射通道** | **连接 Symbol 与其 State 的唯一合法边** |
| **STATE_COPY** | **映射通道的拷贝** | 表示映射能力在不同通道间的平级传播 |
| **STATE_INCLUSION** | **通道的结构性嵌套** | 建模字段隶属关系（） |
| **STATE_IS_USED** | **通道的直接触发** | 语句直接作用于映射通道（如字面量注入） |
| **CALL_RETURN** | 过程间传播 | 调用与返回引起通道关系的流转 |

---

## 4. 核心语义辨析：State 作为“通道”的必要性

1. **解耦命名与取值**：通过 State 节点，Lian 能够表达“多个 Symbol 共享同一个映射通道（别名）”或“一个通道指向多个 Abstract Value（多值性）”。
2. **显式化传播逻辑**：
* **STATE_COPY**：解决“谁拥有谁的映射”的问题。
* **STATE_INCLUSION**：解决“谁是谁的成员”的问题。


3. **指向唯一性**：`SYMBOL_STATE` 是进入值空间的唯一入口，任何分析不得跳过 State 节点直接让 Symbol 触碰 Abstract Value。

---

## 5. 永久锁定区（Locked Sections）

为保证框架的长期一致性，以下定义严禁修改：

1. **State 的通道属性**：State 永远只能作为映射通道，不得实现为物理存储层。
2. **SFG 的层级分离**：Symbol 节点与 State 节点必须严格分离。
3. **分析时序**：指针分析产生的结果必须是构造 SFG 通道关系的依据。

---

## 6. 宪法级总结

**Lian 的分析模型以“符号—抽象值—状态映射”为核心；**
**SFG 描述的是映射通道的拓扑关系（如何建立、如何拷贝、如何嵌套），而非程序的时序执行过程。**
