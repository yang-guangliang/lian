# 语言差异性兼容

GIR及统一程序分析引擎都是基于多种编程语言的共性语义进行设计。然而，不同语言在语法结构、运行时模型以及标准库行为等方面仍然存在显著差异。为统一处理这些差异，LIAN引入了基于事件驱动的插件机制，用于对语言相关的特殊语义进行局部扩展。

该机制的基本原则是，将语言相关的处理逻辑限定在明确的事件触发点内，从而避免语言差异直接影响核心分析流程。

## 1 事件和事件管理

事件（Event）是触发语言定制化处理逻辑的基本单元，由语言类型与事件类型共同标识。事件相关的数据通过`EventData`结构进行封装，其中包含语言标识、事件编号以及事件处理所需的输入与输出信息。

事件管理器（`event_manager`）负责事件的注册与触发：

- 事件注册
  插件在注册阶段声明其支持的语言类型和事件类型，并提供相应的事件处理函数。

- 事件触发
  当分析流程触发某一事件时，事件管理器按注册顺序调用匹配的处理函数；若同一事件对应多个处理函数，则依次执行，直至某一处理函数明确终止后续处理。

事件的触发通过对目标分析模块进行插装完成，统一经由事件管理器提供的`notify()`接口进行调度，从而将事件调度逻辑与核心分析流程解耦。

## 2 事件处理函数设计

事件类型采用前后置钩子的命名约定，主要包括以下两类：

- `XXX_BEFORE`：在目标操作执行之前触发；
- `XXX_READY`或`XXX_AFTER`：在目标操作完成之后触发。

当前事件机制主要覆盖以下分析阶段：

- GIR翻译前端：包括源代码预处理，以及GIR扁平化之前和之后的关键处理点；
- 语义分析阶段：包括指令在进行指向关系分析之前和之后的处理位置（对应`stmt_states`）。

在源代码预处理阶段，事件机制用于处理语言相关的语法与结构差异，例如：

- Python中`from..import..`形式导入语句的重构；
- PHP的注释移除与命名空间展开；
- 浮点数常量的规范化处理。

在GIR中间表示层面，事件处理函数用于完成语言统一化操作：

- 统一`this`/`self`关键字表示，映射为`%this`并作为保留关键字存在；
- 补全变量声明，使动态语言中的赋值语句在GIR层面等价为“变量声明+赋值”；如果变量声明已存在，则不需要额外处理。
- 为源文件自动插入统一的主函数`%unit_init()`，以规范文件初始化函数（也可作为默认入口函数）。

在语义分析阶段，事件主要用于处理字段访问、对象初始化以及方法调用等操作。例如，在JavaScript中，通过在字段读取前触发`P2STATE_FIELD_READ_BEFORE`事件，对调用链相关语义进行定制化处理，以适配其动态对象模型。

## 3 外部系统（External System）机制说明

外部系统用于描述或近似刻画外部函数或接口，在分析过程中为第三方库函数或系统API提供可插拔的语义近似。对外部函数处理支持多种形式：

- 代码型描述
  通过简化的模拟代码表达外部函数的行为，用于在分析过程中提供近似语义，适用于结构相对简单、语义明确的外部接口。

- 规则型描述
  通过配置文件定义外部函数参数与返回值之间的抽象传播关系。配置内容包括语言类型、方法标识及传播路径描述。规则使用特殊标记表示数据源和目标：%this表示当前对象，%arg[0-9]+表示参数位置，%return表示返回值。系统解析配置后生成内部规则对象，并在分析过程中应用。

- 模型型描述
  对于难以通过规则或模拟代码表达的复杂调用模式，允许使用分析框架内部函数进行定制化建模，以覆盖特定语言或库的调用约定。

在LIAN中，外部系统通过函数调用相关事件与插件机制集成。例如，在函数调用分析阶段，通过触发`P2STATE_EXTERN_CALLEE`事件，将调用信息交由外部系统进行匹配和处理；若存在适用规则，则由外部系统接管该调用点的分析逻辑。

## 4 总结

基于事件的插件机制为LIAN框架提供明确的语言差异处理方式，使多语言程序能够在统一分析流程下进行建模与分析。通过将语言特有行为限定在清晰的事件边界和插件接口内，该机制在保持核心分析流程稳定的同时，保留了对不同语言语义特征的扩展空间。
