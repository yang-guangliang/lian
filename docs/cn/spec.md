# Lian莲花程序分析框架

## 1. 程序语义（Program Semantics）

### 1.1 符号（Symbol）

符号是程序源代码中所有标识符的**静态实体**。

* **范畴**：变量名、函数名、类名、参数名、临时标识符（Temp）。
* **本质**：语法层面的命名引用，本身不携带运行期取值信息。

### 1.2 内存抽象 (Memory Abstraction State)

内存抽象是对运行期内存内容空间的结构化建模。一个状态state是内存内容被抽象后的，包含：

1. **内存标识（ID）**：抽象域中的唯一识别符，不等同于 Allocation Site
2. **类型属性（Type Attribute）**：元数据属性，并不作为分析的组织轴心
3. **真实值（Value）**：内存的具体可能取值，包括整数值、字符串、函数ID、类ID等
4. **字段状态（Field States）**：建模`object.field`引入的内容结构，记录对象字段field，及其对应的抽象内存状态
5. **数组状态（Array States）**：建模`array[index]`引入的内部结构，记录数组位置index，及其对应的抽象内存状态

#### 1.3 指向关系（Points-to Relationship）

指向关系记录了一个符号与其运行时所有可达的抽象内容状态的集合。

---

## 2. 分析流水线（Authoritative Pipeline）

1. **GIR 转换**：源语言  GIR，保证语义完整性。
2. **指针级分析**：推导符号指向关系，确立 **Symbol → State → AbstractValue** 的映射链路。
3. **语言差异性兼容**：通过规则/插件处理特定语言语义（如原型链、self 绑定）。
4. **SFG 构造与安全分析**：在映射通道基础上构建状态流图，执行污点跟踪。

---

## 3. 状态流图（State Flow Graph, SFG）

### 3.1 节点定义（SFG_NODE_KIND）

* `SYMBOL`：静态命名节点。
* `STATE`：**映射通道节点**（Symbol 到其 Abstract Value 集合的关联枢纽）。
* `STMT`：程序语句节点。
* `REGULAR`：通用辅助节点。

### 3.2 边定义与语义（SFG_EDGE_KIND）

| 边类型 | 语义描述 | 核心约束 |
| --- | --- | --- |
| **SYMBOL_IS_DEFINED** | 语句定义符号 |  |
| **SYMBOL_IS_USED** | 语句使用符号 |  |
| **SYMBOL_FLOW** | 符号间直接数据流 | 静态层面的值传递 |
| **SYMBOL_STATE** | **符号挂接映射通道** | **连接 Symbol 与其 State 的唯一合法边** |
| **STATE_COPY** | **映射通道的拷贝** | 表示映射能力在不同通道间的平级传播 |
| **STATE_INCLUSION** | **通道的结构性嵌套** | 建模字段隶属关系（） |
| **STATE_IS_USED** | **通道的直接触发** | 语句直接作用于映射通道（如字面量注入） |
| **CALL_RETURN** | 过程间传播 | 调用与返回引起通道关系的流转 |

---

## 4. 核心语义辨析：State 作为“通道”的必要性

1. **解耦命名与取值**：通过 State 节点，Lian 能够表达“多个 Symbol 共享同一个映射通道（别名）”或“一个通道指向多个 Abstract Value（多值性）”。
2. **显式化传播逻辑**：
* **STATE_COPY**：解决“谁拥有谁的映射”的问题。
* **STATE_INCLUSION**：解决“谁是谁的成员”的问题。


3. **指向唯一性**：`SYMBOL_STATE` 是进入值空间的唯一入口，任何分析不得跳过 State 节点直接让 Symbol 触碰 Abstract Value。

---

## 5. 永久锁定区（Locked Sections）

为保证框架的长期一致性，以下定义严禁修改：

1. **State 的通道属性**：State 永远只能作为映射通道，不得实现为物理存储层。
2. **SFG 的层级分离**：Symbol 节点与 State 节点必须严格分离。
3. **分析时序**：指针分析产生的结果必须是构造 SFG 通道关系的依据。

---

## 6. 宪法级总结

**Lian 的分析模型以“符号—抽象值—状态映射”为核心；**
**SFG 描述的是映射通道的拓扑关系（如何建立、如何拷贝、如何嵌套），而非程序的时序执行过程。**
